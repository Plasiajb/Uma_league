{% extends "guest/base.html" %}

{% block title %}{{ event.name }} - Uma League{% endblock %}

{% block content %}
<h2 class="mb-3">{{ event.name }} <span class="badge bg-secondary">{{ event.get_format_display }}</span></h2>
<p class="text-muted">轮数：{{ event.rounds }} | 分组数：{{ event.group_count }}</p>

{% if request.user.is_authenticated %}
  <p>
    <a href="{% url 'enroll_event' event.id %}" class="btn btn-success btn-sm"><i class="bi bi-pencil-square me-1"></i> 报名参加</a>
    {% if can_report %}
      <a href="{% url 'report_results' event.id %}" class="btn btn-info btn-sm ms-2"><i class="bi bi-card-checklist me-1"></i> 战绩填报</a>
    {% endif %}
  </p>
{% else %}
  <div class="alert alert-primary">
      <a href="{% url 'login' %}">登录</a> 后可报名与填报。
  </div>
{% endif %}

<div class="accordion mt-4" id="eventDetailsAccordion">

    {% if published %}
    <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePublished">公布名次 (仅展示)</button></h2>
        <div id="collapsePublished" class="accordion-collapse collapse show" data-bs-parent="#eventDetailsAccordion">
            <div class="accordion-body">
                <table class="table table-sm"><thead><tr><th>名次</th><th>选手</th><th>备注</th></tr></thead><tbody>
                    {% for p in published %}<tr><td>{{ p.rank }}</td><td><a href="{% url 'player_profile' p.player.id %}">{{ p.player.name }}</a></td><td>{{ p.note }}</td></tr>{% endfor %}
                </tbody></table>
            </div>
        </div>
    </div>
    {% endif %}
    
    <div class="accordion-item">
      <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseRooms">房间号</button></h2>
      <div id="collapseRooms" class="accordion-collapse collapse" data-bs-parent="#eventDetailsAccordion">
        <div class="accordion-body">
            <table class="table table-sm"><thead><tr><th>轮次</th><th>组别</th><th>房间号</th><th>操作</th></tr></thead><tbody>
            {% for h in heats %}<tr><td>{{ h.round_no }}</td><td>{{ h.group.name }}</td><td><code>{{ h.room_code }}</code></td><td>{% if user.is_authenticated %}<a href="{% url 'set_room_code' event.id h.round_no h.group.name %}">填写/修改</a>{% endif %}</td></tr>{% endfor %}
            </tbody></table>
        </div>
      </div>
    </div>
    
    <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGroups">分组名单</button></h2>
        <div id="collapseGroups" class="accordion-collapse collapse" data-bs-parent="#eventDetailsAccordion">
            <div class="accordion-body">
                <div class="accordion" id="groupMembersByRound">
                    {% for gm in group_members %}
                        {% ifchanged gm.round_no %}
                            {% if not forloop.first %}
                                    </tbody></table>
                                </div>
                            </div>
                        </div>
                            {% endif %}
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#group-round-collapse-{{ gm.round_no }}">
                                    第 {{ gm.round_no }} 轮
                                </button>
                            </h2>
                            <div id="group-round-collapse-{{ gm.round_no }}" class="accordion-collapse collapse" data-bs-parent="#groupMembersByRound">
                                <div class="accordion-body">
                                    <table class="table table-sm table-borderless">
                                        <thead><tr><th>组别</th><th>选手</th></tr></thead>
                                        <tbody>
                        {% endifchanged %}
                        <tr>
                            <td>{{ gm.group.name }}</td>
                            <td><a href="{% url 'player_profile' gm.player.id %}">{{ gm.player.name }}</a></td>
                        </tr>
                        {% if forloop.last %}
                                    </tbody></table>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% empty %}
                        <p class="text-muted">暂无分组信息。</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStandings">积分榜</button></h2>
        <div id="collapseStandings" class="accordion-collapse collapse" data-bs-parent="#eventDetailsAccordion">
            <div class="accordion-body">
                <table class="table table-sm table-striped">
                    <thead><tr><th>名次</th><th>选手</th><th>累计积分 (越小越好)</th></tr></thead>
                    <tbody>
                      {% for s in standings %}
                        <tr>
                          <td>{{ s.rank }}</td>
                          <td><a href="{% url 'player_profile' s.player.id %}">{{ s.player.name }}</a></td>
                          <td>{{ s.total_score }}</td>
                        </tr>
                      {% empty %}
                        <tr><td colspan="3" class="text-center text-muted">暂无积分信息。</td></tr>
                      {% endfor %}
                    </tbody>
                  </table>
            </div>
        </div>
    </div>

    <div class="accordion-item">
        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseResults">每轮结果</button></h2>
        <div id="collapseResults" class="accordion-collapse collapse" data-bs-parent="#eventDetailsAccordion">
            <div class="accordion-body">
                <div class="accordion" id="resultsByRound">
                    {% for r in results %}
                        {% ifchanged r.heat.round_no %}
                            {% if not forloop.first %}
                                    </tbody></table>
                                </div>
                            </div>
                        </div>
                            {% endif %}
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#result-round-collapse-{{ r.heat.round_no }}">
                                    第 {{ r.heat.round_no }} 轮
                                </button>
                            </h2>
                            <div id="result-round-collapse-{{ r.heat.round_no }}" class="accordion-collapse collapse" data-bs-parent="#resultsByRound">
                                <div class="accordion-body">
                                    <table class="table table-sm table-borderless">
                                        <thead><tr><th>组别</th><th>选手</th><th>马#</th><th>名次</th></tr></thead>
                                        <tbody>
                        {% endifchanged %}
                        <tr>
                            <td>{{ r.heat.group.name }}</td>
                            <td><a href="{% url 'player_profile' r.player.id %}">{{ r.player.name }}</a></td>
                            <td>{{ r.horse_no }}</td>
                            <td>{{ r.place }}</td>
                        </tr>
                        {% if forloop.last %}
                                    </tbody></table>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% empty %}
                        <p class="text-muted">暂无比赛结果。</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    </div>
{% endblock %}